import numpy as np
import pandas as pd

# === DOSYA YOLLARI ===
INPUT_XLSX = r"D:\KISISEL\DOKTORA\4_TIK\9000\SUMMARY_9000_20251219_172012.xlsx"
OUTPUT_XLSX = r"D:\KISISEL\DOKTORA\4_TIK\9000\EUCLID_9000_20251219_172012.xlsx"

PULLUK_SHEET = "PULLUK_NORM01"
TASIMA_SHEET = "TASIMA_NORM01"

def euclid_matrix_from_norm01(df: pd.DataFrame, nmax: int = 13) -> pd.DataFrame:
    """
    NORM01 tablosundan Öklid mesafe matrisi üretir.
    Satırlar: metrikler
    Sütunlar: testler
    """
    base_cols = {"METRIK", "BIRIM"}
    sample_cols = [c for c in df.columns if c not in base_cols]
    sample_cols = sample_cols[:nmax]

    if len(sample_cols) == 0:
        raise ValueError("METRIK / BIRIM dışı kolon bulunamadı")

    # Her test = bir vektör
    X = df[sample_cols].astype(float).to_numpy().T

    # Öklid mesafesi
    diff = X[:, None, :] - X[None, :, :]
    D = np.sqrt(np.sum(diff ** 2, axis=2))

    return pd.DataFrame(D, index=sample_cols, columns=sample_cols)

def main():
    pulluk_df = pd.read_excel(INPUT_XLSX, sheet_name=PULLUK_SHEET)
    tasima_df = pd.read_excel(INPUT_XLSX, sheet_name=TASIMA_SHEET)

    pulluk_dist = euclid_matrix_from_norm01(pulluk_df, nmax=13)
    tasima_dist = euclid_matrix_from_norm01(tasima_df, nmax=13)

    with pd.ExcelWriter(OUTPUT_XLSX, engine="openpyxl") as writer:
        pulluk_dist.to_excel(writer, sheet_name="PULLUK_EUCLID")
        tasima_dist.to_excel(writer, sheet_name="TASIMA_EUCLID")

    print("OKLID UZAKLIKLARI BASARIYLA HESAPLANDI")
    print("PULLUK matrisi:", pulluk_dist.shape)
    print("TASIMA matrisi:", tasima_dist.shape)

if __name__ == "__main__":
    main()
